import pickle
import random
import time

import numpy as np
from settings import *
from plots_lib import *
from tensorflow.keras.callbacks import TensorBoard, EarlyStopping
from sklearn.utils import shuffle
from tensorflow.keras.layers import Dense, Activation, Flatten, Conv2D, MaxPooling2D
from tensorflow.keras.models import Sequential

# tensorboard --logdir="logs"

X_test = np.array(pickle.load(open(X_TEST_PICKLED, "rb")))
y_test = np.array(pickle.load(open(Y_TEST_PICKLED, "rb")))

X_val = np.array(pickle.load(open(X_VAL_PICKLED, "rb")))
y_val = np.array(pickle.load(open(Y_VAL_PICKLED, "rb")))

X_train = np.array(pickle.load(open(X_TRAIN_PICKLED, "rb")))
y_train = np.array(pickle.load(open(Y_TRAIN_PICKLED, "rb")))

categories_number = len(np.unique(y_train))
print(f"Number of categories: {categories_number}")
print(f"Number of all training images: {len(y_train)}")
print('Training dataset shape')
print(X_train.shape)

print(y_train)
X_train, y_train = shuffle(X_train, y_train)
X_val, y_val = shuffle(X_val, y_val)
print(y_train)

X_train = X_train / 255.0
X_val = X_val / 255.0
X_test = X_test / 255.0

history_arr = []
epochs = 10

dense_size = 64
NAME = f"{int(time.time())}-road_signs_recognition-dense-{dense_size}-epochs-{epochs}"
print(NAME)

model = Sequential()

model.add(Flatten())

model.add(Dense(dense_size))
model.add(Activation("relu"))

model.add(Dense(categories_number))
model.add(Activation("sigmoid"))

loss_function = "sparse_categorical_crossentropy"
optimizer = "adam"
metric = "sparse_categorical_accuracy"

model.compile(loss=loss_function,
              optimizer=optimizer,
              metrics=[metric])
history = model.fit(X_train, y_train, validation_data=(X_val, y_val),
                    batch_size=64, epochs=epochs,
                    # callbacks=[early_stopping]
                    )

history_arr.append(history)
model.summary()

print('\n# Evaluate on test data')
results = model.evaluate(X_test, y_test)
print('test loss, test acc:', results)
plot_accuracy_history(history, metric, f'acc_{NAME}')
plot_loss_history(history, loss_function, f'loss_{NAME}')

print("#####################################################")

NAME = f"{int(time.time())}-rgb-road_signs_recognition-conv-{'32(3,3)2x2'}-dense-{'0'}-epochs-{epochs}"
print(NAME)

tensorboard = TensorBoard(log_dir=f'../logs/{NAME}')
early_stopping = EarlyStopping(monitor='val_loss', min_delta=1e-2, patience=2, verbose=1)

model = Sequential()
model.add(Conv2D(32, (3, 3), input_shape=X_train.shape[1:]))
model.add(Activation("relu"))
model.add(MaxPooling2D(pool_size=(2, 2)))

model.add(Flatten())

model.add(Dense(categories_number))
model.add(Activation("sigmoid"))

loss_function = "sparse_categorical_crossentropy"
optimizer = "adam"
metric = "sparse_categorical_accuracy"

model.compile(loss=loss_function,
              optimizer=optimizer,
              metrics=[metric])

history = model.fit(X_train, y_train, validation_data=(X_val, y_val),
                    batch_size=64, epochs=epochs,
                    # callbacks=[early_stopping]
                    )
history_arr.append(history)
model.summary()

print('\n# Evaluate on test data')
results = model.evaluate(X_test, y_test)
print('test loss, test acc:', results)
plot_accuracy_history(history, metric, f'acc_{NAME}')
plot_loss_history(history, loss_function, f'loss_{NAME}')

plot_multi_val_accuracy(history_arr, ['Sieć bez warstwy konwolucyjnej', 'Sieć z warstwą konwolucyjną'], metric,
                        'rgb_conv_vs_no_conv_val_accuracy')
plot_multi_val_loss(history_arr, ['Sieć bez warstwy konwolucyjnej', 'Sieć z warstwą konwolucyjną'],
                    'rgb_conv_vs_no_conv_val_loss')

################# TEST ON RGB DATASET ##############################
# Number of categories: 19
# Number of all training images: 95084
# Training dataset shape
# (95084, 32, 32, 3)
# [ 0  0  0 ... 18 18 18]
# [ 4 11  8 ...  4  6  8]
# 1578622991-road_signs_recognition-dense-64-epochs-10
# 2020-01-10 03:23:12.012071: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA
# 2020-01-10 03:23:12.032972: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 3192580000 Hz
# 2020-01-10 03:23:12.033121: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x56ffe80 executing computations on platform Host. Devices:
# 2020-01-10 03:23:12.033134: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): Host, Default Version
# 2020-01-10 03:23:12.148733: W tensorflow/core/framework/cpu_allocator_impl.cc:81] Allocation of 2336784384 exceeds 10% of system memory.
# 2020-01-10 03:23:13.237454: W tensorflow/core/framework/cpu_allocator_impl.cc:81] Allocation of 702554112 exceeds 10% of system memory.
# Train on 95084 samples, validate on 28587 samples
# Epoch 1/10
# 95084/95084 [==============================] - 7s 71us/sample - loss: 1.2550 - sparse_categorical_accuracy: 0.6643 - val_loss: 0.9250 - val_sparse_categorical_accuracy: 0.7353
# Epoch 2/10
# 95084/95084 [==============================] - 6s 64us/sample - loss: 0.7335 - sparse_categorical_accuracy: 0.8194 - val_loss: 0.7485 - val_sparse_categorical_accuracy: 0.7917
# Epoch 3/10
# 95084/95084 [==============================] - 6s 62us/sample - loss: 0.5977 - sparse_categorical_accuracy: 0.8496 - val_loss: 0.6358 - val_sparse_categorical_accuracy: 0.8294
# Epoch 4/10
# 95084/95084 [==============================] - 6s 63us/sample - loss: 0.5152 - sparse_categorical_accuracy: 0.8675 - val_loss: 0.6232 - val_sparse_categorical_accuracy: 0.8280
# Epoch 5/10
# 95084/95084 [==============================] - 6s 66us/sample - loss: 0.4695 - sparse_categorical_accuracy: 0.8766 - val_loss: 0.6322 - val_sparse_categorical_accuracy: 0.8185
# Epoch 6/10
# 95084/95084 [==============================] - 6s 64us/sample - loss: 0.4320 - sparse_categorical_accuracy: 0.8854 - val_loss: 0.5741 - val_sparse_categorical_accuracy: 0.8396
# Epoch 7/10
# 95084/95084 [==============================] - 6s 62us/sample - loss: 0.4066 - sparse_categorical_accuracy: 0.8914 - val_loss: 0.5853 - val_sparse_categorical_accuracy: 0.8368
# Epoch 8/10
# 95084/95084 [==============================] - 6s 65us/sample - loss: 0.3886 - sparse_categorical_accuracy: 0.8949 - val_loss: 0.5348 - val_sparse_categorical_accuracy: 0.8520
# Epoch 9/10
# 95084/95084 [==============================] - 6s 65us/sample - loss: 0.3718 - sparse_categorical_accuracy: 0.8989 - val_loss: 0.5397 - val_sparse_categorical_accuracy: 0.8505
# Epoch 10/10
# 95084/95084 [==============================] - 6s 64us/sample - loss: 0.3611 - sparse_categorical_accuracy: 0.9019 - val_loss: 0.5549 - val_sparse_categorical_accuracy: 0.8464
# Model: "sequential"
# _________________________________________________________________
# Layer (type)                 Output Shape              Param #
# =================================================================
# flatten (Flatten)            multiple                  0
# _________________________________________________________________
# dense (Dense)                multiple                  196672
# _________________________________________________________________
# activation (Activation)      multiple                  0
# _________________________________________________________________
# dense_1 (Dense)              multiple                  1235
# _________________________________________________________________
# activation_1 (Activation)    multiple                  0
# =================================================================
# Total params: 197,907
# Trainable params: 197,907
# Non-trainable params: 0
# _________________________________________________________________
#
# # Evaluate on test data
# 1216/1 [================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================] - 0s 85us/sample - loss: 0.5246 - sparse_categorical_accuracy: 0.7895
# test loss, test acc: [1.0076765842233344, 0.7894737]
# #####################################################
# 1578623055-rgb-road_signs_recognition-conv-32(3,3)2x2-dense-0-epochs-10
# 2020-01-10 03:24:15.374530: W tensorflow/core/framework/cpu_allocator_impl.cc:81] Allocation of 2336784384 exceeds 10% of system memory.
# 2020-01-10 03:24:16.493503: W tensorflow/core/framework/cpu_allocator_impl.cc:81] Allocation of 702554112 exceeds 10% of system memory.
# Train on 95084 samples, validate on 28587 samples
# Epoch 1/10
# 95084/95084 [==============================] - 33s 345us/sample - loss: 0.6141 - sparse_categorical_accuracy: 0.8289 - val_loss: 0.4487 - val_sparse_categorical_accuracy: 0.8675
# Epoch 2/10
# 95084/95084 [==============================] - 34s 355us/sample - loss: 0.2520 - sparse_categorical_accuracy: 0.9330 - val_loss: 0.3694 - val_sparse_categorical_accuracy: 0.8924
# Epoch 3/10
# 95084/95084 [==============================] - 32s 338us/sample - loss: 0.1911 - sparse_categorical_accuracy: 0.9487 - val_loss: 0.3588 - val_sparse_categorical_accuracy: 0.8957
# Epoch 4/10
# 95084/95084 [==============================] - 32s 340us/sample - loss: 0.1581 - sparse_categorical_accuracy: 0.9573 - val_loss: 0.3664 - val_sparse_categorical_accuracy: 0.8979
# Epoch 5/10
# 95084/95084 [==============================] - 33s 347us/sample - loss: 0.1348 - sparse_categorical_accuracy: 0.9623 - val_loss: 0.4148 - val_sparse_categorical_accuracy: 0.8860
# Epoch 6/10
# 95084/95084 [==============================] - 33s 342us/sample - loss: 0.1206 - sparse_categorical_accuracy: 0.9662 - val_loss: 0.3846 - val_sparse_categorical_accuracy: 0.8975
# Epoch 7/10
# 95084/95084 [==============================] - 33s 344us/sample - loss: 0.1074 - sparse_categorical_accuracy: 0.9703 - val_loss: 0.3708 - val_sparse_categorical_accuracy: 0.9035
# Epoch 8/10
# 95084/95084 [==============================] - 32s 339us/sample - loss: 0.0975 - sparse_categorical_accuracy: 0.9730 - val_loss: 0.4052 - val_sparse_categorical_accuracy: 0.8886
# Epoch 9/10
# 95084/95084 [==============================] - 36s 380us/sample - loss: 0.0894 - sparse_categorical_accuracy: 0.9749 - val_loss: 0.3635 - val_sparse_categorical_accuracy: 0.9100
# Epoch 10/10
# 95084/95084 [==============================] - 41s 431us/sample - loss: 0.0839 - sparse_categorical_accuracy: 0.9766 - val_loss: 0.3619 - val_sparse_categorical_accuracy: 0.9104
# Model: "sequential_1"
# _________________________________________________________________
# Layer (type)                 Output Shape              Param #
# =================================================================
# conv2d (Conv2D)              (None, 30, 30, 32)        896
# _________________________________________________________________
# activation_2 (Activation)    (None, 30, 30, 32)        0
# _________________________________________________________________
# max_pooling2d (MaxPooling2D) (None, 15, 15, 32)        0
# _________________________________________________________________
# flatten_1 (Flatten)          (None, 7200)              0
# _________________________________________________________________
# dense_2 (Dense)              (None, 19)                136819
# _________________________________________________________________
# activation_3 (Activation)    (None, 19)                0
# =================================================================
# Total params: 137,715
# Trainable params: 137,715
# Non-trainable params: 0
# _________________________________________________________________
#
# # Evaluate on test data
# 1216/1 [================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================] - 0s 182us/sample - loss: 0.4162 - sparse_categorical_accuracy: 0.8594
# test loss, test acc: [0.831184830127289, 0.859375]
#
# Process finished with exit code 0

import pickle
import random
import time

import numpy as np
from settings import *
from plots_lib import *
from tensorflow.keras.callbacks import TensorBoard, EarlyStopping
from sklearn.utils import shuffle
from tensorflow.keras.layers import Dense, Activation, Flatten, Conv2D, MaxPooling2D, Dropout
from tensorflow.keras.models import Sequential

# tensorboard --logdir="logs"

X_test = np.array(pickle.load(open(X_TEST_PICKLED, "rb")))
y_test = np.array(pickle.load(open(Y_TEST_PICKLED, "rb")))

X_val = np.array(pickle.load(open(X_VAL_PICKLED, "rb")))
y_val = np.array(pickle.load(open(Y_VAL_PICKLED, "rb")))

X_train = np.array(pickle.load(open(X_TRAIN_PICKLED, "rb")))
y_train = np.array(pickle.load(open(Y_TRAIN_PICKLED, "rb")))

categories_number = len(np.unique(y_train))
print(f"Number of categories: {categories_number}")
print(f"Number of all training images: {len(y_train)}")
print('Training dataset shape')
print(X_train.shape)

X_train, y_train = shuffle(X_train, y_train)
X_val, y_val = shuffle(X_val, y_val)

X_train = X_train / 255.0
X_val = X_val / 255.0
X_test = X_test / 255.0

epochs = 20

NAME = f"{int(time.time())}-gray-road_signs_recognition-conv-{'32x32x64x128'}-sigmoid"
print(NAME)

tensorboard = TensorBoard(log_dir=f'../logs/{NAME}')
early_stopping = EarlyStopping(monitor='val_loss', min_delta=1e-2, patience=2, verbose=1)

model = Sequential()

model.add(Conv2D(32, (5, 5), input_shape=X_train.shape[1:], padding='Same'))
model.add(Activation("relu"))
model.add(Conv2D(32, (5, 5)))
model.add(Activation("relu"))

model.add(MaxPooling2D(pool_size=(2, 2)))

model.add(Dropout(0.25))

model.add(Conv2D(64, (3, 3)))
model.add(Activation("relu"))
model.add(Conv2D(128, (3, 3)))
model.add(Activation("relu"))

model.add(Dropout(0.25))

model.add(MaxPooling2D(pool_size=(2, 2)))

model.add(Flatten())

model.add(Dense(categories_number))
model.add(Activation("sigmoid"))

loss_function = "sparse_categorical_crossentropy"
optimizer = "adam"
metric = "sparse_categorical_accuracy"

model.compile(loss=loss_function,
              optimizer=optimizer,
              metrics=[metric])

history = model.fit(X_train, y_train, validation_data=(X_val, y_val),
                    batch_size=64, epochs=epochs,
                    callbacks=[early_stopping]
                    )

model.summary()

print('\n# Evaluate on test data')
results = model.evaluate(X_test, y_test)
print('test loss, test acc:', results)

model.save(f"../saved_models/{NAME}.model")

plot_accuracy_history(history, metric, f'acc_{NAME}')
plot_loss_history(history, loss_function, f'loss_{NAME}')


#
# /home/piotr/Dokumenty/inzynierka/road_signs_recognition_system/venv/bin/python /home/piotr/Dokumenty/inzynierka/road_signs_recognition_system/src/gray_conv_network.py
# Number of categories: 19
# Number of all training images: 95084
# Training dataset shape
# (95084, 32, 32, 1)
# 1578721238-gray-road_signs_recognition-conv-32x32x64x128-sigmoid
# 2020-01-11 06:40:38.876381: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA
# 2020-01-11 06:40:38.896945: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 3192620000 Hz
# 2020-01-11 06:40:38.897311: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x48a4e00 executing computations on platform Host. Devices:
# 2020-01-11 06:40:38.897329: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): Host, Default Version
# 2020-01-11 06:40:39.091849: W tensorflow/core/framework/cpu_allocator_impl.cc:81] Allocation of 778928128 exceeds 10% of system memory.
# Train on 95084 samples, validate on 28587 samples
# Epoch 1/20
# 95084/95084 [==============================] - 302s 3ms/sample - loss: 0.4556 - sparse_categorical_accuracy: 0.8663 - val_loss: 0.2983 - val_sparse_categorical_accuracy: 0.9134
# Epoch 2/20
# 95084/95084 [==============================] - 326s 3ms/sample - loss: 0.1754 - sparse_categorical_accuracy: 0.9487 - val_loss: 0.2757 - val_sparse_categorical_accuracy: 0.9165
# Epoch 3/20
# 95084/95084 [==============================] - 320s 3ms/sample - loss: 0.1338 - sparse_categorical_accuracy: 0.9602 - val_loss: 0.1986 - val_sparse_categorical_accuracy: 0.9394
# Epoch 4/20
# 95084/95084 [==============================] - 317s 3ms/sample - loss: 0.1134 - sparse_categorical_accuracy: 0.9657 - val_loss: 0.1873 - val_sparse_categorical_accuracy: 0.9442
# Epoch 5/20
# 95084/95084 [==============================] - 356s 4ms/sample - loss: 0.0961 - sparse_categorical_accuracy: 0.9707 - val_loss: 0.1761 - val_sparse_categorical_accuracy: 0.9472
# Epoch 6/20
# 95084/95084 [==============================] - 330s 3ms/sample - loss: 0.0855 - sparse_categorical_accuracy: 0.9737 - val_loss: 0.1801 - val_sparse_categorical_accuracy: 0.9496
# Epoch 7/20
# 95084/95084 [==============================] - 333s 4ms/sample - loss: 0.0785 - sparse_categorical_accuracy: 0.9758 - val_loss: 0.1864 - val_sparse_categorical_accuracy: 0.9468
# Epoch 00007: early stopping
# Model: "sequential"
# _________________________________________________________________
# Layer (type)                 Output Shape              Param #
# =================================================================
# conv2d (Conv2D)              (None, 32, 32, 32)        832
# _________________________________________________________________
# activation (Activation)      (None, 32, 32, 32)        0
# _________________________________________________________________
# conv2d_1 (Conv2D)            (None, 28, 28, 32)        25632
# _________________________________________________________________
# activation_1 (Activation)    (None, 28, 28, 32)        0
# _________________________________________________________________
# max_pooling2d (MaxPooling2D) (None, 14, 14, 32)        0
# _________________________________________________________________
# dropout (Dropout)            (None, 14, 14, 32)        0
# _________________________________________________________________
# conv2d_2 (Conv2D)            (None, 12, 12, 64)        18496
# _________________________________________________________________
# activation_2 (Activation)    (None, 12, 12, 64)        0
# _________________________________________________________________
# conv2d_3 (Conv2D)            (None, 10, 10, 128)       73856
# _________________________________________________________________
# activation_3 (Activation)    (None, 10, 10, 128)       0
# _________________________________________________________________
# dropout_1 (Dropout)          (None, 10, 10, 128)       0
# _________________________________________________________________
# max_pooling2d_1 (MaxPooling2 (None, 5, 5, 128)         0
# _________________________________________________________________
# flatten (Flatten)            (None, 3200)              0
# _________________________________________________________________
# dense (Dense)                (None, 19)                60819
# _________________________________________________________________
# activation_4 (Activation)    (None, 19)                0
# =================================================================
# Total params: 179,635
# Trainable params: 179,635
# Non-trainable params: 0
# _________________________________________________________________
#
# # Evaluate on test data
# 1216/1 [================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================] - 1s 600us/sample - loss: 0.2995 - sparse_categorical_accuracy: 0.8931
# test loss, test acc: [0.5988575126191694, 0.8930921]
# 2020-01-11 07:18:46.797444: W tensorflow/python/util/util.cc:299] Sets are not currently considered sequences, but this may change in the future, so consider avoiding using them.
# WARNING:tensorflow:From /home/piotr/Dokumenty/inzynierka/road_signs_recognition_system/venv/lib/python3.6/site-packages/tensorflow_core/python/ops/resource_variable_ops.py:1781: calling BaseResourceVariable.__init__ (from tensorflow.python.ops.resource_variable_ops) with constraint is deprecated and will be removed in a future version.
# Instructions for updating:
# If using Keras pass *_constraint arguments to layers.
#
# Process finished with exit code 0


#
# /home/piotr/Dokumenty/inzynierka/road_signs_recognition_system/venv/bin/python /home/piotr/Dokumenty/inzynierka/road_signs_recognition_system/src/gray_conv_network.py
# Number of categories: 19
# Number of all training images: 95084
# Training dataset shape
# (95084, 32, 32, 1)
# 1578755334-gray-road_signs_recognition-conv-32x32x64x128-sigmoid
# 2020-01-11 16:08:54.615799: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA
# 2020-01-11 16:08:54.637010: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 3192605000 Hz
# 2020-01-11 16:08:54.637387: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x3f02c90 executing computations on platform Host. Devices:
# 2020-01-11 16:08:54.637403: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): Host, Default Version
# 2020-01-11 16:08:54.830014: W tensorflow/core/framework/cpu_allocator_impl.cc:81] Allocation of 778928128 exceeds 10% of system memory.
# Train on 95084 samples, validate on 28587 samples
# Epoch 1/20
# 95084/95084 [==============================] - 306s 3ms/sample - loss: 0.4442 - sparse_categorical_accuracy: 0.8694 - val_loss: 0.2789 - val_sparse_categorical_accuracy: 0.9158
# Epoch 2/20
# 95084/95084 [==============================] - 302s 3ms/sample - loss: 0.1654 - sparse_categorical_accuracy: 0.9517 - val_loss: 0.2013 - val_sparse_categorical_accuracy: 0.9417
# Epoch 3/20
# 95084/95084 [==============================] - 307s 3ms/sample - loss: 0.1241 - sparse_categorical_accuracy: 0.9631 - val_loss: 0.2139 - val_sparse_categorical_accuracy: 0.9374
# Epoch 4/20
# 95084/95084 [==============================] - 309s 3ms/sample - loss: 0.1032 - sparse_categorical_accuracy: 0.9693 - val_loss: 0.2244 - val_sparse_categorical_accuracy: 0.9332
# Epoch 00004: early stopping
# Model: "sequential"
# _________________________________________________________________
# Layer (type)                 Output Shape              Param #
# =================================================================
# conv2d (Conv2D)              (None, 32, 32, 32)        832
# _________________________________________________________________
# activation (Activation)      (None, 32, 32, 32)        0
# _________________________________________________________________
# conv2d_1 (Conv2D)            (None, 28, 28, 32)        25632
# _________________________________________________________________
# activation_1 (Activation)    (None, 28, 28, 32)        0
# _________________________________________________________________
# max_pooling2d (MaxPooling2D) (None, 14, 14, 32)        0
# _________________________________________________________________
# dropout (Dropout)            (None, 14, 14, 32)        0
# _________________________________________________________________
# conv2d_2 (Conv2D)            (None, 12, 12, 64)        18496
# _________________________________________________________________
# activation_2 (Activation)    (None, 12, 12, 64)        0
# _________________________________________________________________
# conv2d_3 (Conv2D)            (None, 10, 10, 128)       73856
# _________________________________________________________________
# activation_3 (Activation)    (None, 10, 10, 128)       0
# _________________________________________________________________
# dropout_1 (Dropout)          (None, 10, 10, 128)       0
# _________________________________________________________________
# max_pooling2d_1 (MaxPooling2 (None, 5, 5, 128)         0
# _________________________________________________________________
# flatten (Flatten)            (None, 3200)              0
# _________________________________________________________________
# dense (Dense)                (None, 19)                60819
# _________________________________________________________________
# activation_4 (Activation)    (None, 19)                0
# =================================================================
# Total params: 179,635
# Trainable params: 179,635
# Non-trainable params: 0
# _________________________________________________________________
#
# # Evaluate on test data
# 1216/1 [================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================] - 1s 579us/sample - loss: 0.2838 - sparse_categorical_accuracy: 0.8906
# test loss, test acc: [0.563644414197992, 0.890625]
# 2020-01-11 16:29:19.741826: W tensorflow/python/util/util.cc:299] Sets are not currently considered sequences, but this may change in the future, so consider avoiding using them.
# WARNING:tensorflow:From /home/piotr/Dokumenty/inzynierka/road_signs_recognition_system/venv/lib/python3.6/site-packages/tensorflow_core/python/ops/resource_variable_ops.py:1781: calling BaseResourceVariable.__init__ (from tensorflow.python.ops.resource_variable_ops) with constraint is deprecated and will be removed in a future version.
# Instructions for updating:
# If using Keras pass *_constraint arguments to layers.
#
# Process finished with exit code 0

# 1578757683-gray-road_signs_recognition-conv-32x32x64x128-sigmoid.model
# Evaluate on test data
# 1216/1 [================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================] - 1s 794us/sample - loss: 0.3721 - sparse_categorical_accuracy: 0.8890
# test loss, test acc: [0.7440278594745474, 0.88898027]
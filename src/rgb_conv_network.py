import pickle
import random
import time

import numpy as np
from settings import *
from plots_lib import *
from tensorflow.keras.callbacks import TensorBoard, EarlyStopping
from sklearn.utils import shuffle
from tensorflow.keras.layers import Dense, Activation, Flatten, Conv2D, MaxPooling2D
from tensorflow.keras.models import Sequential

# tensorboard --logdir="logs"

X_test = np.array(pickle.load(open(X_TEST_PICKLED, "rb")))
y_test = np.array(pickle.load(open(Y_TEST_PICKLED, "rb")))

X_val = np.array(pickle.load(open(X_VAL_PICKLED, "rb")))
y_val = np.array(pickle.load(open(Y_VAL_PICKLED, "rb")))

X_train = np.array(pickle.load(open(X_TRAIN_PICKLED, "rb")))
y_train = np.array(pickle.load(open(Y_TRAIN_PICKLED, "rb")))

categories_number = len(np.unique(y_train))
print(f"Number of categories: {categories_number}")
print(f"Number of all training images: {len(y_train)}")
print('Training dataset shape')
print(X_train.shape)

print(y_train)
X_train, y_train = shuffle(X_train, y_train)
X_val, y_val = shuffle(X_val, y_val)
print(y_train)

X_train = X_train / 255.0
X_val = X_val / 255.0
X_test = X_test / 255.0

epochs = 10

NAME = f"{int(time.time())}-rgb-road_signs_recognition-conv-{'32(3,3)2x2'}-dense-{'0'}-epochs-{epochs}"
print(NAME)

tensorboard = TensorBoard(log_dir=f'../logs/{NAME}')
early_stopping = EarlyStopping(monitor='val_loss', min_delta=1e-2, patience=2, verbose=1)

model = Sequential()

model.add(Conv2D(32, (3, 3), input_shape=X_train.shape[1:]))
model.add(Activation("relu"))
model.add(MaxPooling2D(pool_size=(2, 2)))

model.add(Conv2D(64, (3, 3), input_shape=X_train.shape[1:]))
model.add(Activation("relu"))
model.add(MaxPooling2D(pool_size=(2, 2)))

model.add(Flatten())

model.add(Dense(categories_number))
model.add(Activation("sigmoid"))

loss_function = "sparse_categorical_crossentropy"
optimizer = "adam"
metric = "sparse_categorical_accuracy"

model.compile(loss=loss_function,
              optimizer=optimizer,
              metrics=[metric])

history = model.fit(X_train, y_train, validation_data=(X_val, y_val),
                    batch_size=64, epochs=epochs,
                    callbacks=[early_stopping]
                    )

model.summary()

print('\n# Evaluate on test data')
results = model.evaluate(X_test, y_test)
print('test loss, test acc:', results)
plot_accuracy_history(history, metric, f'acc_{NAME}')
plot_loss_history(history, loss_function, f'loss_{NAME}')

# /home/piotr/Dokumenty/inzynierka/road_signs_recognition_system/venv/bin/python /home/piotr/Dokumenty/inzynierka/road_signs_recognition_system/src/rgb_conv_network.py
# Number of categories: 19
# Number of all training images: 95084
# Training dataset shape
# (95084, 32, 32, 3)
# [ 0  0  0 ... 18 18 18]
# [17  4 18 ... 11  8  0]
# 1578625357-rgb-road_signs_recognition-conv-32(3,3)2x2-dense-0-epochs-10
# 2020-01-10 04:02:37.069318: I tensorflow/core/platform/cpu_feature_guard.cc:142] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA
# 2020-01-10 04:02:37.089031: I tensorflow/core/platform/profile_utils/cpu_utils.cc:94] CPU Frequency: 3192580000 Hz
# 2020-01-10 04:02:37.089301: I tensorflow/compiler/xla/service/service.cc:168] XLA service 0x4753f10 executing computations on platform Host. Devices:
# 2020-01-10 04:02:37.089319: I tensorflow/compiler/xla/service/service.cc:175]   StreamExecutor device (0): Host, Default Version
# 2020-01-10 04:02:37.234966: W tensorflow/core/framework/cpu_allocator_impl.cc:81] Allocation of 2336784384 exceeds 10% of system memory.
# 2020-01-10 04:02:38.330346: W tensorflow/core/framework/cpu_allocator_impl.cc:81] Allocation of 702554112 exceeds 10% of system memory.
# Train on 95084 samples, validate on 28587 samples
# Epoch 1/10
# 95084/95084 [==============================] - 53s 559us/sample - loss: 0.5651 - sparse_categorical_accuracy: 0.8362 - val_loss: 0.2991 - val_sparse_categorical_accuracy: 0.9122
# Epoch 2/10
# 95084/95084 [==============================] - 52s 546us/sample - loss: 0.1795 - sparse_categorical_accuracy: 0.9497 - val_loss: 0.2521 - val_sparse_categorical_accuracy: 0.9249
# Epoch 3/10
# 95084/95084 [==============================] - 53s 555us/sample - loss: 0.1233 - sparse_categorical_accuracy: 0.9653 - val_loss: 0.2026 - val_sparse_categorical_accuracy: 0.9414
# Epoch 4/10
# 95084/95084 [==============================] - 56s 588us/sample - loss: 0.0916 - sparse_categorical_accuracy: 0.9732 - val_loss: 0.2308 - val_sparse_categorical_accuracy: 0.9341
# Epoch 5/10
# 95084/95084 [==============================] - 53s 559us/sample - loss: 0.0746 - sparse_categorical_accuracy: 0.9777 - val_loss: 0.1879 - val_sparse_categorical_accuracy: 0.9466
# Epoch 6/10
# 95084/95084 [==============================] - 52s 550us/sample - loss: 0.0611 - sparse_categorical_accuracy: 0.9816 - val_loss: 0.2055 - val_sparse_categorical_accuracy: 0.9479
# Epoch 7/10
# 95084/95084 [==============================] - 53s 559us/sample - loss: 0.0530 - sparse_categorical_accuracy: 0.9842 - val_loss: 0.1988 - val_sparse_categorical_accuracy: 0.9506
# Epoch 00007: early stopping
# Model: "sequential"
# _________________________________________________________________
# Layer (type)                 Output Shape              Param #
# =================================================================
# conv2d (Conv2D)              (None, 30, 30, 32)        896
# _________________________________________________________________
# activation (Activation)      (None, 30, 30, 32)        0
# _________________________________________________________________
# max_pooling2d (MaxPooling2D) (None, 15, 15, 32)        0
# _________________________________________________________________
# conv2d_1 (Conv2D)            (None, 13, 13, 64)        18496
# _________________________________________________________________
# activation_1 (Activation)    (None, 13, 13, 64)        0
# _________________________________________________________________
# max_pooling2d_1 (MaxPooling2 (None, 6, 6, 64)          0
# _________________________________________________________________
# flatten (Flatten)            (None, 2304)              0
# _________________________________________________________________
# dense (Dense)                (None, 19)                43795
# _________________________________________________________________
# activation_2 (Activation)    (None, 19)                0
# =================================================================
# Total params: 63,187
# Trainable params: 63,187
# Non-trainable params: 0
# _________________________________________________________________
#
# # Evaluate on test data
# 1216/1 [================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================] - 0s 227us/sample - loss: 0.6277 - sparse_categorical_accuracy: 0.9104
# test loss, test acc: [0.5540145948374043, 0.9103618]
#
# Process finished with exit code 0
